<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Peta Hotspot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* ... [STYLE SAMA DENGAN SEBELUMNYA, TIDAK DIULANG DI SINI UNTUK KEJELASAN] ... */
  </style>
</head>
<body>
  <!-- ... [BODY DAN FILTER SAMA SEPERTI SEBELUMNYA] ... -->

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-pip@latest/leaflet-pip.min.js"></script>
  <script>
    const map = L.map('map', { attributionControl: false }).setView([-2.5, 117], 5);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom:18 }).addTo(map);
    const hotspotLayer = L.layerGroup().addTo(map);

    let pbphLayer = null, kebunLayer = null, gambutLayer = null;

    fetch('provinsi.geojson').then(r=>r.json()).then(g => L.geoJSON(g, { style:{color:"black",weight:1,fillOpacity:0} }).addTo(map));

    fetch('PBPH.geojson').then(r=>r.json()).then(g=>{
      pbphLayer = L.geoJSON(g, {
        style:{color:"blue",weight:1,fillOpacity:0},
        onEachFeature:(f,l)=>l.bindPopup(Object.entries(f.properties).map(kv=>`<b>${kv[0]}</b>: ${kv[1]}`).join('<br>'))
      });
    });
    fetch('kebun.geojson').then(r=>r.json()).then(g=>{
      kebunLayer = L.geoJSON(g, {
        style:{color:"green",weight:2,fillOpacity:0.1},
        onEachFeature:(f,l)=>l.bindPopup(Object.entries(f.properties).map(kv=>`<b>${kv[0]}</b>: ${kv[1]}`).join('<br>'))
      });
    });
    fetch('gambut.geojson').then(r=>r.json()).then(g=>{
      gambutLayer = L.geoJSON(g, {
        style:{color:"brown",weight:2,fillOpacity:0.1},
        onEachFeature:(f,l)=>l.bindPopup(Object.entries(f.properties).map(kv=>`<b>${kv[0]}</b>: ${kv[1]}`).join('<br>'))
      });
    });

    document.getElementById('pbph-toggle').addEventListener('change', e => e.target.checked ? pbphLayer?.addTo(map) : map.removeLayer(pbphLayer));
    document.getElementById('kebun-toggle').addEventListener('change', e => e.target.checked ? kebunLayer?.addTo(map) : map.removeLayer(kebunLayer));
    document.getElementById('gambut-toggle').addEventListener('change', e => e.target.checked ? gambutLayer?.addTo(map) : map.removeLayer(gambutLayer));

    const url = "https://opensheet.elk.sh/1Vce5YUId7cUZ29j8OEhdFSer26cszXgX3OSm5zoX1UI/Data%20Hotspot%20Nasional";
    let rawData = [];

    function getLastThreeDates() {
      const opt = {day:'2-digit',month:'long',year:'numeric'};
      return [0,1,2].map(i => {
        const d = new Date(); d.setDate(d.getDate()-i);
        return d.toLocaleDateString('id-ID', opt);
      });
    }

    function extractTanggal(tj) {
      const p = tj.split(',')[1]?.trim().split(' ')||[];
      return p.slice(0,3).join(' ');
    }

    function renderFilterTanggal() {
      const div = document.getElementById("tanggal-filter");
      div.innerHTML = '';
      getLastThreeDates().forEach(t => div.innerHTML += `<label><input type="checkbox" class="tanggal-filter" value="${t}" checked> ${t}</label>`);
    }

    function renderFilterSumber(data) {
      const set = new Set(data.map(r=>r.Sumber?.trim()).filter(r=>r));
      const div = document.getElementById("sumber-filter");
      div.innerHTML = '';
      Array.from(set).sort().forEach(s => div.innerHTML += `<label><input type="checkbox" class="sumber-filter" value="${s}" checked> ${s}</label>`);
    }

    function getSelectedFilters() {
      return {
        levels: [...document.querySelectorAll('.confidence-filter:checked')].map(cb=>cb.value),
        tanggal: [...document.querySelectorAll('.tanggal-filter:checked')].map(cb=>cb.value),
        sumber: [...document.querySelectorAll('.sumber-filter:checked')].map(cb=>cb.value)
      };
    }

    function applyFilters() {
      const {levels, tanggal, sumber} = getSelectedFilters();
      hotspotLayer.clearLayers();
      rawData.forEach(r => {
        const lat = parseFloat(r.Latitude), lon = parseFloat(r.Longitude);
        const conf = r.Confidence_Level?.toLowerCase();
        const t = extractTanggal(r["Tanggal & Jam"]||"");
        const s = r.Sumber?.trim();
        if(!isNaN(lat)&&!isNaN(lon)&&levels.includes(conf)&&tanggal.includes(t)&&sumber.includes(s)) {
          L.circleMarker([lat,lon],{radius:6,fillColor:conf==='high'?'red':'yellow',color:'#000',weight:1,opacity:0.5,fillOpacity:0.5})
           .addTo(hotspotLayer)
           .bindPopup(`<b>${r["Tanggal & Jam"]}</b><br>${r.Provinsi} - ${r["Kab/Kota"]}<br>Kecamatan: ${r.Kecamatan || ''}<br>Desa: ${r.Desa || ''}<br>Confidence: ${conf}<br>Sumber: ${s}<br>Koordinat: ${lat.toFixed(4)}, ${lon.toFixed(4)}<br><a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank">üìç Lihat di Google Maps</a>`);
        }
      });
    }

    function fetchAndRenderData() {
      fetch(url).then(r=>r.json()).then(data=>{
        rawData = data;
        renderFilterTanggal();
        renderFilterSumber(data);
        applyFilters();
        document.querySelectorAll('.filters input[type=checkbox]').forEach(cb=>cb.addEventListener('change',applyFilters));
      });
    }

    function exportHotspotPerusahaan() {
      const { levels, tanggal, sumber } = getSelectedFilters();
      const filtered = rawData.filter(r => {
        const conf = r.Confidence_Level?.toLowerCase();
        const t = extractTanggal(r["Tanggal & Jam"]||"");
        const s = r.Sumber?.trim();
        return levels.includes(conf)&&tanggal.includes(t)&&sumber.includes(s);
      });

      const stats = [];

      filtered.forEach(r => {
        const lat = parseFloat(r.Latitude), lon = parseFloat(r.Longitude);
        if(isNaN(lat)||isNaN(lon)) return;

        let jenis = "", nama = "", inGambut = "Tidak";

        if(pbphLayer){
          const hit = leafletPip.pointInLayer([lon,lat], pbphLayer);
          if(hit.length){
            jenis = "PBPH";
            nama = hit[0].feature.properties.Nama_Perusahaan || hit[0].feature.properties.Perusahaan || "‚Äî";
          }
        }

        if(kebunLayer && !nama){
          const hit = leafletPip.pointInLayer([lon,lat], kebunLayer);
          if(hit.length){
            jenis = "Perkebunan";
            nama = hit[0].feature.properties.Nama_Perusahaan || hit[0].feature.properties.Perusahaan || "‚Äî";
          }
        }

        if(gambutLayer){
          const hit = leafletPip.pointInLayer([lon,lat], gambutLayer);
          if(hit.length){
            inGambut = "Ya";
          }
        }

        if(nama){
          stats.push([
            nama,
            jenis,
            r.Confidence_Level?.toLowerCase()==='high'?1:0,
            r.Confidence_Level?.toLowerCase()==='medium'?1:0,
            r.Provinsi || "‚Äî",
            extractTanggal(r["Tanggal & Jam"]||""),
            inGambut
          ]);
        }
      });

      const merged = {};
      stats.forEach(([nama, jenis, high, medium, prov, tgl, gambut]) => {
        const key = `${nama}-${jenis}-${gambut}`;
        if(!merged[key]){
          merged[key] = {
            nama, jenis, high:0, medium:0, provinsi: new Set(), tanggal: new Set(), gambut
          };
        }
        merged[key].high += high;
        merged[key].medium += medium;
        merged[key].provinsi.add(prov);
        merged[key].tanggal.add(tgl);
      });

      const rows = Object.values(merged).map(s => [
        s.nama,
        s.jenis,
        s.high + s.medium,
        s.high,
        s.medium,
        [...s.provinsi].join(', '),
        [...s.tanggal].join(', '),
        s.gambut
      ]);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Hotspot di Perusahaan",14,16);
      doc.autoTable({
        startY:22,
        head:[['Perusahaan','Jenis Perizinan','Total','High','Medium','Provinsi','Tanggal','Di Lokasi Gambut']],
        body: rows,
        styles:{ fontSize:8 }
      });
      doc.save("hotspot_perusahaan.pdf");
    }

    function checkPassword() {
      const pw = document.getElementById('password-input').value;
      if(pw==="karla") {
        localStorage.setItem("hotspot_logged_in","true");
        document.getElementById('login-overlay').style.display='none';
        init();
      } else {
        document.getElementById('login-error').style.display='block';
      }
    }

    function init() {
      fetchAndRenderData();
    }

    window.onload = () => {
      if(localStorage.getItem("hotspot_logged_in")==="true") {
        document.getElementById('login-overlay').style.display='none';
        init();
      }
    };
  </script>
</body>
</html>
